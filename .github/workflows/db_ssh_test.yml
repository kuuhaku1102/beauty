name: SSH Tunnel DB Test

on:
  workflow_dispatch:

jobs:
  test-db:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -p ${{ secrets.SSH_PORT }} -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Create SSH Tunnel
        run: |
          ssh -f -N -L 3307:127.0.0.1:3306 -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.11

      - name: Install dependencies
        run: pip install sqlalchemy pymysql

      - name: Test DB Connection via SSH Tunnel
        env:
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASS: ${{ secrets.DB_PASS }}
          DB_NAME: ${{ secrets.DB_NAME }}
        run: |
          python - <<'PYCODE'
          from sqlalchemy import create_engine, text
          import os

          db_user = os.environ["DB_USER"]
          db_pass = os.environ["DB_PASS"]
          db_name = os.environ["DB_NAME"]

          url = f"mysql+pymysql://{db_user}:{db_pass}@127.0.0.1:3307/{db_name}?charset=utf8mb4"
          print("Connecting via SSH tunnel:", url.replace(db_pass, "********"))
          engine = create_engine(url, echo=False)
          with engine.connect() as conn:
              result = conn.execute(text("SELECT NOW();"))
              print("âœ… Connected successfully:", result.scalar())
          PYCODE
